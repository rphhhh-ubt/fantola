FROM node:18-alpine

WORKDIR /app

RUN corepack enable && corepack prepare pnpm@9.12.3 --activate

COPY pnpm-workspace.yaml package.json pnpm-lock.yaml ./
COPY packages/config/package.json ./packages/config/
COPY packages/shared/package.json ./packages/shared/
COPY packages/test-utils/package.json ./packages/test-utils/
COPY services/api/package.json ./services/api/
COPY services/bot/package.json ./services/bot/
COPY services/worker/package.json ./services/worker/

RUN pnpm install --frozen-lockfile

COPY . .

RUN pnpm build

CMD ["pnpm", "test:ci"]
